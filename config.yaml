# ============================================================
# SLAM Configuration
# ============================================================

# --- Data source ---
data_file: "data/ugvlidar-full.csv"

# --- ICP parameters ---
# method: "point_to_line" (recommended for 2D) or "point_to_point" (classic)
icp:
  method: "point_to_line"
  normal_k: 10                  # neighbours for normal estimation (point_to_line only)
  voxel_size: 0.06
  error_threshold: 1.0e-10
  max_iterations: 100
  error_reject_threshold: 0.05  # skip scan if ICP error > this value

# --- Pre-alignment (handles large inter-scan rotations) ---
# method: "rotation_search" | "features" | "both" | "none"
#   rotation_search — brute-force tries every angle, most robust
#   features        — curvature keypoints + RANSAC (fast, less robust)
#   both            — rotation search first, features to refine
#   none            — no pre-alignment (vanilla ICP only)
features:
  method: "rotation_search"

  # ─ correlative rotation search ─
  rotation_voxel_size: 0.3   # coarse voxel for the angle sweep (meters)
  angle_step_coarse: 2.0      # degrees per step in the full [-180°,180°) sweep
  angle_step_fine: 0.2        # degrees per step in the refinement band

  # ─ feature-based alignment (used when method is "features" or "both") ─
  voxel_size: 0.3       # coarse downsample for feature extraction (meters)
  k_curvature: 10       # neighbours used for curvature estimation
  top_n: 100            # max keypoints per scan
  min_kp_dist: 0.3      # non-max suppression radius (meters)
  k_descriptor: 30      # neighbours for sorted-distance descriptor
  ratio_threshold: 0.8  # Lowe's ratio test for descriptor matching
  ransac_iterations: 1000
  inlier_threshold: 0.5 # RANSAC inlier distance (meters)
  min_inliers: 3        # minimum inliers to accept alignment (else fall back to identity)

# --- Point cloud filter (z-slice before flattening to 2D) ---
filter:
  z_min: 0.75    # meters – discard points below this height
  z_max: 1.0    # meters – discard points above this height

# --- Occupancy grid / mapping ---
mapping:
  resolution: 0.1     # meters per cell
  margin: 50.0        # meters of padding around first scan bounds
  p_hit: 0.9          # probability update for occupied cells (higher = harder to erase)
  p_miss: 0.45        # probability update for free (ray) cells (closer to 0.5 = weaker free updates)
  log_odds_min: -10.0  # clamp lower bound (larger range = more permanence)
  log_odds_max: 10.0   # clamp upper bound

# --- Lidar service ---
service:
  sleep_s: 0.0        # delay between scans (seconds), 0 = as fast as possible
  loop: true           # restart file when end is reached

# --- Run control ---
num_scans: null        # null = unlimited, or set an integer to limit

# --- Live map display ---
display:
  live_map: true
  window_width: 1400
  window_height: 1000
  cmap: "gray"
  clim_min: 0.0
  clim_max: 1.0
  background: "black"
  trajectory_color: "cyan"
  pose_color: "lime"
  pose_size: 12

# --- Output files ---
output:
  csv: "occupancy_grid.csv"
  npy: "occupancy_grid.npy"
